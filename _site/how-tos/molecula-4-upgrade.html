<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>How To Upgrade to Molecula 4.x</title>
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div class="container">
        <header>
            <a href="/"> 
                <img src="/img/logo.svg" alt="Molecula Logo" class="logo">
            </a>
        </header>
        <main class="container__main">
            <!-- Left sidebar -->
            <aside class="container__left">
                <ul>
    
      
        <li><a href="/index.html">Home</a></li>
        
  
      
    
       
        <li><p>Tutorials</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/tutorials/getting-started.html">Getting Started</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Explanation</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/explanations/architecture.html">Architecture</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>How-Tos</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/how-tos/install-featurebase.html">Install FeatureBase</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Reference</a></li>
        
  
      
        <ul>
    
       
        <li><p>Interfaces</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/reference/apis.html">APIs</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Query Languages</a></li>
        
  
      
    
       
        <li><p>Operations</a></li>
        
  
      
    
       
        <li><p>Configuration</a></li>
        
  
      
    
      
        <li><a href="/reference/glossary.html">Glossary</a></li>
        
  
      
    
  </ul>

      
    
  </ul>

            </aside>
    
            <article class="container__middle">
                <h1>How To Upgrade to Molecula 4.x</h1>
                <section>
                  <h2 id="summary">Summary</h2>
<p>Molecula 4.x includes FeatureBase version 3.x, which is the main change from Molecula version 3.x, which included Pilosa version 2.x.</p>

<p>In Molecula version 4.x, we have introduced a product rename from Pilosa to FeatureBase, roaring B-tree format for storage, and etcd for key-value store. These changes were made to improve high availability and consistency.</p>

<h3 id="pilosa-rename">Pilosa Rename</h3>
<p>Pilosa was renamed to FeatureBase. For details, refer to the <a href="/reference/featurebase-rename">FeatureBase Rename</a> page.</p>
<h3 id="roaring-b-tree-format">Roaring B-tree Format</h3>
<p>The new roaring B-tree format (RBF) storage backend provides ACID semantics at a shard level. It reduces heap usage for more predictable memory consumption and garbage collection behavior.</p>

<h3 id="etcd">etcd</h3>
<p>FeatureBase 3.0 embeds etcd, which uses a Raft-based consensus algorithm to power a strongly consistent key/value store; FeatureBase uses this to maintain cluster state, node state, and data schema. This reduces internal complexity in FeatureBase’s codebase while providing a more reliable store for important metadata.</p>

<h2 id="operationalconfiguration-changes">Operational/Configuration changes</h2>

<h3 id="add-log-prefix-levels">Add Log Prefix Levels</h3>
<p>In FeatureBase v3.x, a log prefix level was introduced. The available prefix levels are <code class="language-plaintext highlighter-rouge">PANIC</code>, 
<code class="language-plaintext highlighter-rouge">ERROR</code>, <code class="language-plaintext highlighter-rouge">WARN</code>, <code class="language-plaintext highlighter-rouge">INFO</code> and <code class="language-plaintext highlighter-rouge">DEBUG</code>.</p>

<p>Pilosa v2.x:</p>

<p><code class="language-plaintext highlighter-rouge">2021-10-22T20:56:32.199996Z Molecula Pilosa v2.8.7 (Oct 22 2021 3:56PM, 02f14f42) go1.16.7</code></p>

<p>FeatureBase v3.x:</p>

<p><code class="language-plaintext highlighter-rouge">2021-10-22T19:32:36.427981Z INFO:  Molecula Pilosa v3.5.0 (Sep 28 2021 6:53PM, f0b93da0) go1.16.3</code></p>

<h3 id="ui-usage">UI Usage</h3>
<p>Some operations on the tables page of the UI can be very expensive on large datasets. One of these operations is the disk usage operation, which can be disabled with the <code class="language-plaintext highlighter-rouge">usage-duty-cycle</code> option (Additional details can be found in the <a href="#configuration">Configuration</a> section). The tables page of the UI also calculates cardinality across all fields, which can be expensive. For FeatureBase v3.5, there is no configuration to disable calculating cardinality, but it is something to be aware of if using the UI.</p>

<h3 id="backup-and-restore-functionality">Backup and Restore Functionality</h3>
<p>FeatureBase v3.x has new backup and restore functionality. For details, refer to the <a href="/reference/backups">Backups</a> page.</p>

<h3 id="configuration">Configuration</h3>

<p>For additional details on the new configuration, refer to the <a href="/reference/featurebase-configuration">FeatureBase Configuration</a></p>

<h4 id="new-configuration">New Configuration</h4>
<p><code class="language-plaintext highlighter-rouge">--name</code>: Set a unique name for this node within the cluster. This is used internally by etcd.</p>

<p><code class="language-plaintext highlighter-rouge">--max-query-memory</code>: Set a limit for max query memory for Extract or Select queries.</p>

<p>Many of the cluster related configuration options have changed. The coordinator node is no longer needed and there is no longer an option to set <code class="language-plaintext highlighter-rouge">coordinator</code> or <code class="language-plaintext highlighter-rouge">hosts</code>.  Instead, the <code class="language-plaintext highlighter-rouge">etcd</code> options must be set.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  --etcd.advertise-peer-address         
  --etcd.cluster-url 
  --etcd.initial-cluster
  --etcd.listen-client-address
  --etcd.listen-peer-address string
</code></pre></div></div>

<p>The entire <code class="language-plaintext highlighter-rouge">gossip</code> section has been removed as that functionality has been replaced by <code class="language-plaintext highlighter-rouge">etcd</code>.</p>

<p><code class="language-plaintext highlighter-rouge">--postgres.sql-version</code>: Set the version for SQL. SQL Version 2 is a new experimental Molecula SQL handling. You do not need to explicitly set this unless you’re trying out the new SQL engine.</p>

<p><code class="language-plaintext highlighter-rouge">--query-history-length</code>: Set the maximum number of queries maintained for the <code class="language-plaintext highlighter-rouge">/query-history</code> endpoint.</p>

<p><code class="language-plaintext highlighter-rouge">--usage-duty-cycle</code>: Set the percentage of time that is spent recalculating the disk and memory usage cache. 100.0 for always-running, 0 disables the cache and the <code class="language-plaintext highlighter-rouge">/ui/usage</code> endpoint. These computations can be quite intensive, and many users disable this endpoint to avoid disruptions.</p>

<p><code class="language-plaintext highlighter-rouge">--future.rename</code>: Set application name as FeatureBase instead of Pilosa. Default is false. Setting this to true changes all the flags and environment variables to use FeatureBase rather than Pilosa.</p>

<p><code class="language-plaintext highlighter-rouge">--long-query-time</code>: Used to be nested under cluster, but it is now top level.</p>

<h3 id="data-directory-structure">Data Directory Structure</h3>
<p>Changes to the data directory structure in FeatureBase were made to account for RBF and etcd changes. For details, refer to the <a href="/explanations/data-directory-structure">Data Directory Structure</a>. In general, the Molecula team would like to discourage reliance on any particular details of the directory structure.</p>

<p>Pilosa v2.x:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls .pilosa/
idalloc.db      index1
</code></pre></div></div>

<p>FeatureBase v3.x:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls .pilosa/
disco       idalloc.db      indexes     startup.log
</code></pre></div></div>

<h2 id="remove-support-for-attributes-in-featurebase">Remove Support for Attributes in FeatureBase</h2>
<p>Pilosa previously provided the ability to associate arbitrary key/value pairs with any row or column in any index. This feature was almost entirely unused, and has been removed.</p>

<h2 id="migration">Migration</h2>

<h3 id="migration-tool-for-rbf">Migration Tool for RBF</h3>
<p>Migration tool was built to convert data from a set of Pilosa v2.x data directories to FeatureBase backup format. Once the conversion is complete, the new FeatureBase restore functionality is used to populate data into an updated cluster.</p>

<h3 id="process-to-migrate-from-pilosa-v2x-to-featurebase-v3x">Process to Migrate from Pilosa v2.x to FeatureBase v3.x</h3>
<h4 id="1-stop-ingest">1. Stop Ingest</h4>

<h4 id="2-backup-as-usual">2. Backup as usual</h4>

<h4 id="3-convert-pilosa-data-to-rbf">3. Convert Pilosa Data to RBF</h4>
<p>The roaring-migrate binary is included in the FeatureBase release. To update Pilosa data to the new roaring B-tree format, run the following command.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./roaring-migrate --data-dir /tmp/pilosa1,/tmp/pilosa2,/tmp/pilosa3 --backup-dir /tmp/backupDir
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">data-dir</code> represents the directory where Pilosa is currently stored. Multiple directories (one for each node in the cluster) can be passed to the <code class="language-plaintext highlighter-rouge">data-dir</code> separated by a comma.</li>
  <li><code class="language-plaintext highlighter-rouge">backup-dir</code> represents the directory where data converted to RBF will be stored.</li>
</ul>

<h4 id="4-stand-up-a-new-featurebase">4. Stand-up a New FeatureBase</h4>
<p>Instructions for setting up FeatureBase are in the <a href="/how-tos/install-featurebase">How to Install FeatureBase</a>. Also, refer to the <a href="/reference/featurebase-configuration">FeatureBase Configuration</a> for additional details. This stop is not necessarily dependent on the previous 3, and if your environment allows this, you’ll probably want to do this first to minimize downtime.</p>

<p>The new FeatureBase cluster needs to contain an odd number of nodes due to reliance on an embedded <code class="language-plaintext highlighter-rouge">etcd</code> cluster.</p>

<h4 id="5-restore-backup">5. Restore Backup</h4>
<p>Once FeatureBase is running, it is time to restore the backup data.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./featurebase restore --source /tmp/backupDir
</code></pre></div></div>

<h4 id="6-start-ingest">6. Start Ingest</h4>
<p>At this stage, the data has been restored to FeatureBase, and ingestion can be restarted.</p>

                </section>
            </article>
    
            <!-- Right sidebar -->
            <nav class="container__right">
                <div>Applies to</div>

                <span>Please <a href="https://github.com/molecula/documentation/edit/gh-pages/how-tos/molecula-4-upgrade.md">help improve this article</a>.</span>

                <div>
                    <span>
                        Modified: 
                    </span>
                </div>

                <div>Feedback?</div>
            </nav>
        </main>
        <footer>
            <p> &copy; 2022 Molecula Corp.</p>
        </footer>
    </div>
  </body>
</html>
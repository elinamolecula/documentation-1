<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Resizing Your FeatureBase Cluster</title>
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div class="container">
        <header>
            <a href="/"> 
                <img src="/img/logo.svg" alt="Molecula Logo" class="logo">
            </a>
        </header>
        <main class="container__main">
            <!-- Left sidebar -->
            <aside class="container__left">
                <ul>
    
      
        <li><a href="/index.html">Home</a></li>
        
  
      
    
       
        <li><p>Tutorials</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/tutorials/getting-started.html">Getting Started</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Explanation</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/explanations/architecture.html">Architecture</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>How-Tos</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/how-tos/install-featurebase.html">Install FeatureBase</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Reference</a></li>
        
  
      
        <ul>
    
       
        <li><p>Interfaces</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/reference/apis.html">APIs</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Query Languages</a></li>
        
  
      
    
       
        <li><p>Operations</a></li>
        
  
      
    
       
        <li><p>Configuration</a></li>
        
  
      
    
      
        <li><a href="/reference/glossary.html">Glossary</a></li>
        
  
      
    
  </ul>

      
    
  </ul>

            </aside>
    
            <article class="container__middle">
                <h1>Resizing Your FeatureBase Cluster</h1>
                <section>
                  <h2 id="summary">Summary</h2>

<p>The cluster backup &amp; restore tooling provides a simple way to extract data from a cluster and restore that data to a new cluster—even if the new cluster is a different size.
We can use this process to migrate from a smaller cluster to a larger one in a relatively short amount of time.</p>

<p>Data in FeatureBase is typically historical data fed in via bulk ingest or streamed in via Kafka or another data pipeline.
As such, the latency requirements are looser than if FeatureBase were a system of record. Migration can be performed in several steps:</p>
<ol>
  <li><a href="#1-start-a-new-featurebase-cluster">Start a new FeatureBase cluster.</a></li>
  <li><a href="#2-stop-ingestion-via-a-bulk-ingester">Stop ingestion via a bulk ingester.</a></li>
  <li><a href="#3-backup-data-from-the-original-featurebase-cluster">Backup data from the original FeatureBase cluster.</a></li>
  <li><a href="#4-restore-data-to-the-new-featurebase-cluster">Restore data to the new FeatureBase cluster.</a></li>
  <li><a href="#5-redirect-traffic-to-the-new-featurebase-cluster">Redirect traffic to the new FeatureBase cluster.</a></li>
  <li><a href="#6-restart-ingestion-against-the-new-featurebase-cluster">Restart ingestion against the new FeatureBase cluster.</a></li>
  <li><a href="#7-shutdown-the-original-featurebase-cluster">Shutdown the original FeatureBase cluster.</a></li>
</ol>

<h2 id="1-start-a-new-featurebase-cluster">1. Start a new FeatureBase cluster.</h2>

<p>First, create a new cluster of the desired size.
The configuration from the old cluster can be reused by changing:</p>

<ul>
  <li><a href="/reference/featurebase-configuration#etcd-listen-client-address"><code class="language-plaintext highlighter-rouge">etcd.listen-client-address</code></a> to the node’s new network address</li>
  <li><a href="/reference/featurebase-configuration#etcd-listen-peer-address"><code class="language-plaintext highlighter-rouge">etcd.listen-peer-address</code></a> to the node’s new network address</li>
  <li><a href="/reference/featurebase-configuration#etcd-initial-cluster"><code class="language-plaintext highlighter-rouge">etcd.initial-cluster</code></a> to use the new network addresses and add additional nodes</li>
</ul>

<p>Additionally, if the replication factor needs to be changed, the <a href="/reference/featurebase-configuration#cluster-replicas"><code class="language-plaintext highlighter-rouge">cluster.replicas</code></a> setting should be updated now.</p>

<h2 id="2-stop-ingestion-via-a-bulk-ingester">2. Stop ingestion via a bulk ingester</h2>

<p>If data is written during/after a backup, it will not end up on the new cluster.
In order to ensure that all data are preserved, shut down the writing processes for the remainder of the migration.
If using an ingest consumer (e.g. <code class="language-plaintext highlighter-rouge">molecula-consumer-kafka</code>), this should be accomplished by completely shutting down the process.
Do not attempt to stall the consumer by creating an exclusive transaction.</p>

<h2 id="3-backup-data-from-the-original-featurebase-cluster">3. Backup data from the original FeatureBase cluster.</h2>

<p>The <code class="language-plaintext highlighter-rouge">featurebase</code> command line tool contains a <a href="/reference/backups#featurebase"><code class="language-plaintext highlighter-rouge">backup</code></a> subcommand for executing a backup against a cluster:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>featurebase backup --host featurebase:10101 -o /path/to/backup/ --concurrency 4 # and TLS config
</code></pre></div></div>
<p>The <a href="/reference/backups#backup-concurrency"><code class="language-plaintext highlighter-rouge">--concurrency</code></a> flag is not required, but setting it to an appropriate number will improve backup speed.</p>

<p>It is possible to speed the process up more by <a href="/reference/backups#storage-synchronization">disabling sync</a> of the backup data:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>featurebase backup --host featurebase:10101 -o /path/to/backup/ --no-sync
</code></pre></div></div>

<p>This will allow the backup to complete without waiting for the operating system to move the data to persistent storage.
If the machine running the backup loses power, you may lose some (or all) of the backup data.</p>

<h2 id="4-restore-data-to-the-new-featurebase-cluster">4. Restore data to the new FeatureBase cluster.</h2>

<p>The <code class="language-plaintext highlighter-rouge">featurebase</code> command line tool has an accompanying <a href="/reference/backups#featurebase">restore</a> subcommand that will restore a directory created by the backup subcommand:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>featurebase restore --host newfeaturebase:10101 -s /path/to/backup/ --concurrency 4
</code></pre></div></div>

<h2 id="5-redirect-traffic-to-the-new-featurebase-cluster">5. Redirect traffic to the new FeatureBase cluster.</h2>

<p>Once the data have been moved over to the new cluster, it is safe to redirect query traffic.
Change the targets of any load balancers, and update configurations for services which may be pointed manually to a node.</p>

<h2 id="6-restart-ingestion-against-the-new-featurebase-cluster">6. Restart ingestion against the new FeatureBase cluster.</h2>

<p>Once the new system is up and running, the <a href="/reference/ingester-configuration">ingester configurations</a> can be updated to point to the new cluster (<code class="language-plaintext highlighter-rouge">pilosa-hosts</code> and <code class="language-plaintext highlighter-rouge">pilosa-grpc-hosts</code>, respectively <code class="language-plaintext highlighter-rouge">--featurebase-hosts</code> and <code class="language-plaintext highlighter-rouge">--featurebase-grpc-hosts</code> with <code class="language-plaintext highlighter-rouge">--future.rename</code> flag).
They can then be started back up to import new data.</p>

<h2 id="7-shutdown-the-original-featurebase-cluster">7. Shutdown the original FeatureBase cluster.</h2>

<p>Once the new cluster is running and appears to be functioning properly, the old cluster may be shut down and deleted.</p>

                </section>
            </article>
    
            <!-- Right sidebar -->
            <nav class="container__right">
                <div>Applies to</div>

                <span>Please <a href="https://github.com/molecula/documentation/edit/gh-pages/how-tos/resizing.md">help improve this article</a>.</span>

                <div>
                    <span>
                        Modified: 
                    </span>
                </div>

                <div>Feedback?</div>
            </nav>
        </main>
        <footer>
            <p> &copy; 2022 Molecula Corp.</p>
        </footer>
    </div>
  </body>
</html>
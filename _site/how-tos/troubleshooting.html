<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Troubleshooting FeatureBase</title>
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div class="container">
        <header>
            <a href="/"> 
                <img src="/img/logo.svg" alt="Molecula Logo" class="logo">
            </a>
        </header>
        <main class="container__main">
            <!-- Left sidebar -->
            <aside class="container__left">
                <ul>
    
      
        <li><a href="/index.html">Home</a></li>
        
  
      
    
       
        <li><p>Tutorials</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/tutorials/getting-started.html">Getting Started</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Explanation</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/explanations/architecture.html">Architecture</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>How-Tos</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/how-tos/install-featurebase.html">Install FeatureBase</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Reference</a></li>
        
  
      
        <ul>
    
       
        <li><p>Interfaces</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/reference/apis.html">APIs</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Query Languages</a></li>
        
  
      
    
       
        <li><p>Operations</a></li>
        
  
      
    
       
        <li><p>Configuration</a></li>
        
  
      
    
      
        <li><a href="/reference/glossary.html">Glossary</a></li>
        
  
      
    
  </ul>

      
    
  </ul>

            </aside>
    
            <article class="container__middle">
                <h1>Troubleshooting FeatureBase</h1>
                <section>
                  <h2 id="featurebase-stops-or-wont-start">FeatureBase Stops Or Won’t Start</h2>

<p>Check the logs. Depending on how you’re running FeatureBase, this can take a few different forms.</p>

<p>If you’re running directly from the command line, you should see some output at the command line. If you don’t see anything useful, take a look at your configuration (check the command line flags, environment variables, and config file if applicable). See if you have a log path specified, and if so, go check there to see the FeatureBase logs.</p>

<p>If you’re running under systemd, you should certainly check any configured log file as above, but you can also check to see what FeatureBase is saying on stdout or stderr by running the command <code class="language-plaintext highlighter-rouge">journalctl -u featurebase -f</code>. The <code class="language-plaintext highlighter-rouge">-f</code> option works similarly to the <code class="language-plaintext highlighter-rouge">tail</code> command and you can leave it off if you want to see the full log from the beginning of time.</p>

<p>If there isn’t a clear error in any of the logs, next you’ll want to check your kernel logs. This is a little bit OS dependent, but usually you can do something like <code class="language-plaintext highlighter-rouge">tail -f /var/log/syslog</code> or <code class="language-plaintext highlighter-rouge">dmesg | tail</code>. The most common thing to see here would be something like <code class="language-plaintext highlighter-rouge">OOM Killed</code> or <code class="language-plaintext highlighter-rouge">Out of memory: Kill process 764</code> which indicates that FeatureBase is being terminated by the OS without warning for using too much memory.</p>

<h2 id="featurebase-throws-an-error-like-cannot-allocate-memory">FeatureBase throws an error like “cannot allocate memory”</h2>

<p>This can happen a few different ways, but typically indicates that the mmap syscall is returning ENOMEM. Confusingly it usually doesn’t mean that you’re actually out of memory. Most often it means that you either:</p>

<ol>
  <li>
    <p>Have surpassed the system limit for maximum mmap count. You can try <code class="language-plaintext highlighter-rouge">sysctl vm.max_map_count</code> to read this value. Default is typically something like 65530, and you might want to set it higher… to something like 256000. You can do this adding a line like <code class="language-plaintext highlighter-rouge">vm.max_map_count=256000</code> to <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code> and then applying the setting with <code class="language-plaintext highlighter-rouge">sysctl -p</code>. Or setting it temporarily with <code class="language-plaintext highlighter-rouge">sysctl -w vm.max_map_count=256000</code>. In either case, you will need to restart FeatureBase after making these changes</p>
  </li>
  <li>
    <p>You’re actually out of memory address space. This can happen because the RBF storage backend maps 4GB memory regions per file by default, and if you get up near 16000 files, you can actually exhaust the address space. In this case, you can tune FeatureBase’s RBF settings to reserve less space for each RBF file:</p>
  </li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[rbf]
max-db-size = 1073741824
max-wal-size = 1073741824
</code></pre></div></div>

<p>In this example we’ve tuned the RBF DB and WAL files to have a maximum size of 1GiB instead of 4GiB. The drawback here is that the maximum size of a shard is now more restricted. Take a look at your existing data directory before you do this and make sure that you don’t have any shard files near the limit you’re setting. You can find shard files in your data directory under <code class="language-plaintext highlighter-rouge">indexes/&lt;indexname&gt;/backends/rbf/shard.XXXX</code>. If you find yourself in a situation where you can’t tune this down because you have large shards, but you need to because you’re running into this error, please let the customer success team know. You may need to add more nodes to your cluster, or our engineering team might want to look at other possible solutions.</p>

                </section>
            </article>
    
            <!-- Right sidebar -->
            <nav class="container__right">
                <div>Applies to</div>

                <span>Please <a href="https://github.com/molecula/documentation/edit/gh-pages/how-tos/troubleshooting.md">help improve this article</a>.</span>

                <div>
                    <span>
                        Modified: 
                    </span>
                </div>

                <div>Feedback?</div>
            </nav>
        </main>
        <footer>
            <p> &copy; 2022 Molecula Corp.</p>
        </footer>
    </div>
  </body>
</html>
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>How To Use the Grafana Plugin</title>
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div class="container">
        <header>
            <a href="/"> 
                <img src="/img/logo.svg" alt="Molecula Logo" class="logo">
            </a>
        </header>
        <main class="container__main">
            <!-- Left sidebar -->
            <aside class="container__left">
                <ul>
    
      
        <li><a href="/index.html">Home</a></li>
        
  
      
    
       
        <li><p>Tutorials</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/tutorials/getting-started.html">Getting Started</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Explanation</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/explanations/architecture.html">Architecture</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>How-Tos</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/how-tos/install-featurebase.html">Install FeatureBase</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Reference</a></li>
        
  
      
        <ul>
    
       
        <li><p>Interfaces</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/reference/apis.html">APIs</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Query Languages</a></li>
        
  
      
    
       
        <li><p>Operations</a></li>
        
  
      
    
       
        <li><p>Configuration</a></li>
        
  
      
    
      
        <li><a href="/reference/glossary.html">Glossary</a></li>
        
  
      
    
  </ul>

      
    
  </ul>

            </aside>
    
            <article class="container__middle">
                <h1>How To Use the Grafana Plugin</h1>
                <section>
                  <p>Molecula provides a Grafana plugin, which can be used to interact with FeatureBase (4.0 or higher <!-- TODO is this correct? -->) to run queries and view visualizations of results. Note that this is unrelated to using Grafana for operational monitoring of the FeatureBase cluster. For details on that, see the <a href="/reference/monitoring">monitoring reference page</a></p>

<h2 id="setup">Setup</h2>

<h3 id="install-grafana">Install Grafana</h3>
<p>For the best experience, <a href="https://grafana.com/grafana/download">install</a> Grafana version 7 using the binary, not brew. The plugin requires version 7 or greater, but version 7 works best. For convenience, here are the commands for mac. For other platforms, check the link.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -O https://dl.grafana.com/enterprise/release/grafana-enterprise-7.5.13.darwin-amd64.tar.gz
tar -zxvf grafana-enterprise-7.5.13.darwin-amd64.tar.gz
</code></pre></div></div>

<h3 id="install-plugin">Install Plugin</h3>
<p>As of FeatureBase 4.3, a Grafana plugin archive should be included in your release archive. Unpack and note the location of the <code class="language-plaintext highlighter-rouge">/dist</code> folder.</p>

<p>In Grafana’s configuration file <code class="language-plaintext highlighter-rouge">grafana-7-x.x/conf/defaults.ini</code> point the <code class="language-plaintext highlighter-rouge">plugins</code> field to the <code class="language-plaintext highlighter-rouge">/dist</code> folder.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>plugins = /path/to/grafana-plugin/molecula/dist
</code></pre></div></div>

<p>Uncomment and add the plugin id to <code class="language-plaintext highlighter-rouge">allow_loading_unsigned_plugins</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>allow_loading_unsigned_plugins = molecula-datasource
</code></pre></div></div>

<p>The port which defaults to <code class="language-plaintext highlighter-rouge">3000</code> can be modified by setting the <code class="language-plaintext highlighter-rouge">http_port</code> field if necessary.</p>

<h3 id="launch-grafana">Launch Grafana</h3>

<p>From <code class="language-plaintext highlighter-rouge">grafana-7-x.x/</code> run the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/grafana-server web
</code></pre></div></div>

<ul>
  <li>Direct your browser to Grafana which should be running on localhost:3000 by default.</li>
</ul>

<h3 id="add-datasource">Add Datasource</h3>

<ul>
  <li>Sign in or create credentials (you can use admin/admin if logging in for the first time)</li>
  <li>Add Molecula as a datasource in Grafana and enter FeatureBase server information
    <ul>
      <li>The welcome page should include a link to the <a href="http://localhost:3000/datasources">Add data source page</a>.
        <ul>
          <li>See the <a href="https://grafana.com/docs/grafana/latest/datasources/add-a-data-source">Grafana docs</a> for more details.</li>
        </ul>
      </li>
      <li>If your molecula-datasource plugin is installed, it should appear in the data source list.</li>
    </ul>
  </li>
</ul>

<p><img src="/img/grafana-welcome.png" alt="Grafana Welcome" title="Grafana Welcome" /><br />
<em>Click “Add your first data source”</em></p>

<p><img src="/img/grafana-add-datasource.png" alt="Grafana Add Datasource" title="Grafana Add Datasource" /><br />
<em>Select the “Molecula” option. The “unsigned” label is expected</em></p>

<h3 id="configure-server">Configure Server</h3>

<p>Point Grafana to a running FeatureBase server</p>
<ul>
  <li>Default FeatureBase address: <code class="language-plaintext highlighter-rouge">localhost</code></li>
  <li>Default FeatureBase GRPC port: <code class="language-plaintext highlighter-rouge">20101</code></li>
  <li><code class="language-plaintext highlighter-rouge">Max Query Results</code> limits the number of records returned by the server if no <code class="language-plaintext highlighter-rouge">Limit</code> call is provided.</li>
</ul>

<p><img src="/img/grafana-configure-server.png" alt="Grafana Configure Datasource" title="Grafana Configure Datasource" /><br />
<em>If Featurebase server is running, you will see a similar message indicating success</em></p>

<h3 id="configure-authentication">Configure Authentication</h3>
<p>If FeatureBase server has authentication enabled, select Auth Enabled Server in the Grafana configuration page for the FeatureBase data source. Two new fields will be displayed: Auth Token and Server CA Cert.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Auth Token</code>: a JWT used for authentication and authorization obtained by following these <a href="/how-tos/enable-auth#how-to-get-auth-token">instructions</a></li>
  <li><code class="language-plaintext highlighter-rouge">Server CA Cert</code>: the contents of the certificate used for TLS on the FeatureBase server</li>
</ul>

<p><img src="/img/grafana-configure-auth.png" alt="Grafana Configure Authentication" title="Grafana Configure Authentication" /><br />
<em>These are secure fields. Contents will be hidden once saved and will require resetting to change the value</em></p>

<h3 id="other-installation-methods">Other Installation Methods</h3>

<h4 id="to-install-grafana-using-docker">To install Grafana using Docker:</h4>

<p>Run the Grafana Docker image with this command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d  \
    -p 3000:3000 \   # app http port
    -p 20101:20101 \ # FeatureBase grpc port
    -v "$(pwd)":/var/lib/grafana/plugins \   # plugin directory volume mount
    --name=grafana \
    -e "GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=molecula-datasource" \   # grafana configuration environment variable
    grafana/grafana:7.5.9
</code></pre></div></div>

<p>After any changes to the plugin directory, restart the container with <code class="language-plaintext highlighter-rouge">docker restart grafana</code>.</p>

<p>Configure the datasource using <code class="language-plaintext highlighter-rouge">host.docker.internal</code> for the server and <code class="language-plaintext highlighter-rouge">20101</code> the grpc port</p>

<h4 id="other-methods">Other methods:</h4>
<p>If your environment requires a different installation method, please refer to the <a href="https://grafana.com/docs/grafana/latest/installation/">Grafana documentation</a>.</p>

<h2 id="creating-panels">Creating Panels</h2>
<!-- TODO: need sample dataset -->
<!-- TODO: dataset-specific examples for each "format as" option -->
<!-- TODO: screenshots of config and results -->

<h3 id="querying">Querying</h3>
<p>The plugin supports any <a href="/reference/sql">SQL</a> and <a href="/reference/pql">PQL</a> queries that FeatureBase supports. When using PQL, the index must be selected from the respective drop down.</p>

<p><img src="/img/grafana-query.png" alt="Query FeatureBase through Grafana" title="Query FeatureBase through Grafana" /><br />
<em>Enter your SQL or PQL query</em></p>

<h4 id="fetching-ids">Fetching Ids</h4>
<p>By default, <code class="language-plaintext highlighter-rouge">_id</code> will be filtered out in query results. Use the ‘Fetch _id’ toggle if required.</p>

<h3 id="data-series-format-as">Data Series (Format As)</h3>
<p>Query results can be broken up in different ways to aid the creation of different types of visualizations.</p>

<h4 id="single-series">Single Series</h4>
<p>Typically used for a single data-series on a time based plot such as, the ‘Graph’ panel. This will require a TimestampField and a numeric field in the query results.</p>

<p>Special Consideration:</p>
<ul>
  <li>DateInt fields will be interpreted as the number of seconds from the Unix epoch if it is named ‘timestamp’.</li>
</ul>

<pre><code class="language-pql">Extract(Limit(All(), limit=1000), Rows(data_size), Rows(timestamp))
</code></pre>
<h4 id="series-by-row">Series By Row</h4>

<p>Typically used for aggregation queries where each row is a distinct category with a statistic.</p>
<pre><code class="language-pql">GroupBy(Rows(city))
</code></pre>
<p>As single series, this would return the count of each distinct city in a single table. But as ‘Series By Row’, it will promote each row to be its own data series.</p>

<h4 id="series-by-metric">Series By Metric</h4>
<p>Typically used when you want to break up the query results into different data-series by the distinct values in a particular column. The column itself must be included in the query and selected as the ‘metric’. <!-- TODO what is "the 'metric'" ??? --></p>

<pre><code class="language-pql">Extract(Limit(All(), limit=1000), Rows(data_size), Rows(timestamp), Rows(customer))
</code></pre>

<p>If ‘customer’ contains the distinct values of ‘CVS’ and ‘Sprint’, the result will be two separate data series.</p>

<h3 id="use-grafana-variables">Use Grafana Variables</h3>

<ul>
  <li>You can insert <a href="https://grafana.com/docs/grafana/latest/variables/variable-types/add-query-variable/">Grafana variables</a> in your query to serve as placeholders. The variable is prepended with a $: <code class="language-plaintext highlighter-rouge">$var_name</code>.</li>
</ul>

<pre><code class="language-pql">Extract(Limit(Row(customer=$customer), limit=1000), Rows(data_size), Rows(timestamp), Rows(customer))
</code></pre>

<ul>
  <li>You can define the values this variable can take in Dashboard Settings &gt; Variables &gt; New.</li>
  <li>Name the variable to match what you used in the query</li>
  <li>For ‘Type’ select ‘Custom’ or ‘Query’
    <ul>
      <li>If ‘Custom’, provide a comma separated list of values</li>
      <li>If ‘Query’, select Molecula as the datasource and provide a SQL query, e.g. <code class="language-plaintext highlighter-rouge">SELECT DISTINCT level FROM logs</code>. PQL cannot be used here.
        <ul>
          <li>To use field <em>names</em> for variable values, use a query like (useful for <code class="language-plaintext highlighter-rouge">Rows</code> calls):
            <ul>
              <li><code class="language-plaintext highlighter-rouge">show fields from &lt;index&gt;</code></li>
            </ul>
          </li>
          <li>To use field <em>values</em> for variable values, use a query like (useful for <code class="language-plaintext highlighter-rouge">Row</code> calls):
            <ul>
              <li><code class="language-plaintext highlighter-rouge">select distinct &lt;field&gt; from &lt;index&gt; limit &lt;integer&gt;</code></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Under Selection Options, you can choose if you would like users to be able to select multiple (or all) values for the variable</li>
</ul>

<p><img src="/img/grafana-variables-edit.png" alt="Grafana Variables Edit" title="Grafana Variables Edit" /><br />
<em>Define your variable by setting the Name, Type, Query (or Custom values), and whether you would like the variable to take multiple values</em></p>

<p>At the top of the dashboard, you can now dynamically select a value with which to process your query.</p>

<p><img src="/img/grafana-variable-select.png" alt="Grafana Variable Select" title="Grafana Variable Select" /><br />
<em>Select a value for your variable in the drop down on the dashboard</em></p>

<h3 id="variable-interpolation">Variable Interpolation</h3>
<p>Variables can be used in the following calls. Interpolation of the variable differs for each call and is demonstrated below:</p>
<h4 id="row">Row</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">$var1</code> has the values: [“Informational”, “Debug”].</li>
  <li>User input: <code class="language-plaintext highlighter-rouge">Count(Row(level=$var1))</code></li>
  <li>Interpolated query: <code class="language-plaintext highlighter-rouge">Count(Union(Row(level="Informational"), Row(level="Debug")))</code></li>
  <li>Conceptually, this is an OR of all selected values</li>
</ul>

<h4 id="rows">Rows</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">$var2</code> has the values: [“customer”, “region”].</li>
  <li>User input: <code class="language-plaintext highlighter-rouge">GroupBy(Rows($var2))</code></li>
  <li>Interpolated query: <code class="language-plaintext highlighter-rouge">GroupBy(Rows("customer"), Rows("region"))</code></li>
</ul>

<p>:::note
Considering how multi-valued variables are interpolated in <code class="language-plaintext highlighter-rouge">Rows</code> calls, you will not want to use it standalone like this:
Rows($var) since you’ll get:
Rows(value1), Rows(value2),…
which is not a valid query. Instead, you’ll want to use it as a child of another call like GroupBy.
:::</p>

<h4 id="constrow">ConstRow</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">$var3</code> has the values: <code class="language-plaintext highlighter-rouge">[5,10,15]</code></li>
  <li>User input:  <code class="language-plaintext highlighter-rouge">Intersect(ConstRow(columns=$var3), Row(region="NW"))</code></li>
  <li>Interpolated query: <code class="language-plaintext highlighter-rouge">Intersect(ConstRow(columns=[5,10,15]), Row(region="NW"))</code></li>
</ul>

<h3 id="time-range-controls">Time Range Controls</h3>

<p>Grafana has time range controls at the top of each graph and dashboard.</p>

<p><img src="/img/grafana-time-range-control.png" alt="Grafana Variable Select" title="Grafana Variable Select" /><br />
<em>Grafana time range selector</em></p>

<p>To utilize these controls, you must associate it with a field in your dataset. This can be done by adding the field name to <code class="language-plaintext highlighter-rouge">TimeField</code> in the query editor. The type of this field must be <code class="language-plaintext highlighter-rouge">timestamp</code>.</p>

<p><img src="/img/grafana-timefield.png" alt="Grafana Variable Select" title="Grafana Variable Select" /><br />
<em>Select the field you would like to associate with Grafana’s time range controls</em></p>

                </section>
            </article>
    
            <!-- Right sidebar -->
            <nav class="container__right">
                <div>Applies to</div>

                <span>Please <a href="https://github.com/molecula/documentation/edit/gh-pages/how-tos/use-grafana-plugin.md">help improve this article</a>.</span>

                <div>
                    <span>
                        Modified: 
                    </span>
                </div>

                <div>Feedback?</div>
            </nav>
        </main>
        <footer>
            <p> &copy; 2022 Molecula Corp.</p>
        </footer>
    </div>
  </body>
</html>
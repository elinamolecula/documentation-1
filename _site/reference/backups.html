<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Backups</title>
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div class="container">
        <header>
            <a href="/"> 
                <img src="/img/logo.svg" alt="Molecula Logo" class="logo">
            </a>
        </header>
        <main class="container__main">
            <!-- Left sidebar -->
            <aside class="container__left">
                <ul>
    
      
        <li><a href="/index.html">Home</a></li>
        
  
      
    
       
        <li><p>Tutorials</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/tutorials/getting-started.html">Getting Started</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Explanation</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/explanations/architecture.html">Architecture</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>How-Tos</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/how-tos/install-featurebase.html">Install FeatureBase</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Reference</a></li>
        
  
      
        <ul>
    
       
        <li><p>Interfaces</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/reference/apis.html">APIs</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Query Languages</a></li>
        
  
      
    
       
        <li><p>Operations</a></li>
        
  
      
    
       
        <li><p>Configuration</a></li>
        
  
      
    
      
        <li><a href="/reference/glossary.html">Glossary</a></li>
        
  
      
    
  </ul>

      
    
  </ul>

            </aside>
    
            <article class="container__middle">
                <h1>Backups</h1>
                <section>
                  <h2 id="featurebase">FeatureBase</h2>

<p>FeatureBase supports backup and restore options through the <code class="language-plaintext highlighter-rouge">featurebase backup</code> and <code class="language-plaintext highlighter-rouge">featurebase restore</code> commands.
These commands transfer data between a FeatureBase cluster and a directory:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>featurebase backup --host featurebase:10101 -o /path/to/backup/
featurebase restore --host featurebase:10101 -s /path/to/backup/
</code></pre></div></div>

<p>Both commands accept the <code class="language-plaintext highlighter-rouge">--host</code> option, which specifies a FeatureBase node by a hostname/IP and a port joined by a colon.
Despite only requiring the address of one node, these commands act on the entire cluster (and thus require network access to all nodes).</p>

<p>The <code class="language-plaintext highlighter-rouge">featurebase backup</code> command accepts an output option (<code class="language-plaintext highlighter-rouge">-o</code> or <code class="language-plaintext highlighter-rouge">--output</code>) to specify the destination directory for the backup.
This is not an incremental backup, so this directory is expected to be empty.
If the directory does not exist, it will be created.</p>

<p>The <code class="language-plaintext highlighter-rouge">featurebase restore</code> command similarly accepts a source option (<code class="language-plaintext highlighter-rouge">-s</code> or <code class="language-plaintext highlighter-rouge">--source</code>) to specify the source directory (from a previous <code class="language-plaintext highlighter-rouge">featurebase backup</code> command).
It should only be executed against an empty cluster.
<code class="language-plaintext highlighter-rouge">featurebase backup</code> and <code class="language-plaintext highlighter-rouge">featurebase restore</code> should not be executed while a <code class="language-plaintext highlighter-rouge">Delete</code> call is in process.</p>

<h2 id="backups-with-authentication">Backups with Authentication</h2>
<p>When authentication is enabled, TLS is also enabled. The <code class="language-plaintext highlighter-rouge">host</code> must use <code class="language-plaintext highlighter-rouge">https</code> for itâ€™s scheme and a valid JWT must be provided using the <code class="language-plaintext highlighter-rouge">auth-token</code> flag. This token may be obtained by following these <a href="/how-tos/enable-auth#how-to-get-auth-token">instructions</a>. Only a user with admin access to FeatureBase will be authorized to perform a backup/restore.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>featurebase backup --host https://featurebase:10101 -o /path/to/backup/ --auth-token &lt;token&gt;
featurebase restore --host https://featurebase:10101 -s /path/to/backup/ --auth-token &lt;token&gt;
</code></pre></div></div>

<p>:::warning
Attempting to restore to a live cluster populated with data may result in data loss and/or system instability.
:::</p>

<p>:::note
This process is only compatible with the RBF <a href="/reference/featurebase-configuration#storage-backend">storage backend</a>.
:::</p>

<h3 id="what-is-included-in-a-backup">What is included in a backup?</h3>

<p>A <code class="language-plaintext highlighter-rouge">featurebase backup</code> includes:</p>
<ul>
  <li>schema</li>
  <li>key translation data</li>
  <li>indexes</li>
  <li>ID allocation state</li>
</ul>

<p>It does not include node configurations or the state of other Molecula components.</p>

<p>When using an external lookup database, this tool will not back up the external database.
The external lookup database must be backed up seperately.</p>

<p>The backup data is independent of the size or replication factor of a cluster.
As such, it is safe to restore a backup to a differently sized cluster.
This can be used to safely <a href="/how-tos/resizing">resize a cluster</a>.</p>

<h3 id="restoring-in-production">Restoring in Production</h3>

<p>The ideal process for restoring to a production installation is:</p>
<ol>
  <li>Stop ingest to the old cluster (if it still exists)</li>
  <li>Start a new cluster</li>
  <li>Use <code class="language-plaintext highlighter-rouge">featurebase restore</code> to apply the data to the cluster</li>
  <li>Verify that the cluster behaves as expected (run some queries and check for expected results)</li>
  <li>Redirect query traffic to the new cluster</li>
  <li>Start ingest to the new cluster</li>
  <li>Back up the old cluster again (if it still exists)</li>
  <li>Tear down the old cluster (if it still exists)</li>
</ol>

<h3 id="consistency">Consistency</h3>

<p>The generated backup is not an instantaneous snapshot, as FeatureBase does not support that consistency level.
Seperate components are backed up in a specific order, such that:</p>
<ol>
  <li>If a record is created before the backup starts and is not modified, it will end up in the backup.</li>
  <li>If a record is created during the backup, it may or may not end up in the backup.</li>
  <li>If a record is modified during the backup, the backup will include either the original or modified state.</li>
  <li>If a record is deleted during the backup, it may or may not end up in the backup.</li>
  <li>All necessary key translation data will end up in the backup.</li>
  <li>IDs committed by the auto ID feature before the start of the backup will not be reused, but other allocated IDs may be reused.</li>
</ol>

<h3 id="tls-configuration">TLS Configuration</h3>

<p>In order to use TLS, the following options are required (for <code class="language-plaintext highlighter-rouge">backup</code> &amp; <code class="language-plaintext highlighter-rouge">restore</code> commands):</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">--tls.ca-certificate</code>: the CA certitificate to use for verifying the server certificate (defaults to CA certs installed to system)</li>
  <li><code class="language-plaintext highlighter-rouge">--tls.certificate</code>: the TLS client certificate to use for <a href="/how-tos/enable-mutual-tls">mTLS</a> authentication</li>
  <li><code class="language-plaintext highlighter-rouge">--tls.key</code>: the client key corresponding to the client certificate (for <a href="/how-tos/enable-mutual-tls">mTLS</a>)</li>
</ul>

<p>For example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>featurebase backup --host featurebase:10101 -o /path/to/backup/ --tls.ca-certificate ca.crt --tls.certificate client.crt --tls.key client.key
featurebase restore --host featurebase:10101 -s /path/to/backup/ --tls.ca-certificate ca.crt --tls.certificate client.crt --tls.key client.key
</code></pre></div></div>

<h3 id="backup-concurrency">Backup Concurrency</h3>

<p>By default, backup and restore operations will transfer one file at a time.
Using the <code class="language-plaintext highlighter-rouge">--concurrency</code> option, many files can be transferred simultaneously for higher throughput:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>featurebase backup --concurrency 2 --host featurebase:10101 -o /path/to/backup/
featurebase restore --concurrency 8 --host featurebase:10101 -s /path/to/backup/
</code></pre></div></div>

<p>When backing up a live production cluster, this concurrency option should be set relatively low (or left at the default of 1).
Setting this value too high may exhaust resources of the system and negatively impact applications using the cluster during the backup.
The optimal tradeoff varies depending on cluster size, CPU speed, disk speed, and system load.
In most scenarios, one per node is a reasonable conservative selection.</p>

<p>When restoring to a fresh cluster, this constraint is not applicable.
The concurrency can be set fairly high, with several concurrent transfers per destination node.
The exact number of optimal restore operations varies depending on network/disk speeds, and should be determined experimentally when doing a test-restore.</p>

<h3 id="storage-synchronization">Storage Synchronization</h3>

<p>By default, <code class="language-plaintext highlighter-rouge">featurebase backup</code> will wait for all backup files to be committed to persistent storage before terminating.
This ensures that the backup will remain intact in the event that the system is forcefully shut down or loses power.
This can be disabled in exchange for higher backup speed with the <code class="language-plaintext highlighter-rouge">--no-sync</code> option when the backup will be written somewhere else in a later step:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>featurebase backup --host featurebase:10101 -o /path/to/backup/ --no-sync # back up FeatureBase without syncing the files to disk
tar -cvf backup.tar.xz /path/to/backup # put the backup in a compressed tar file
sync backup.tar.xz . # sync the tar file to disk and then sync the directory containing it to disk (both are necessary)
rm -r /path/to/backup
</code></pre></div></div>

<h3 id="testing-a-backup">Testing a Backup</h3>

<p>The most reliable way to test a backup is to attempt to restore it.
This can be done by starting a temporary cluster, restoring to that cluster, and executing test operations (e.g. common queries) against it.
This test can be done with a single local node, provided that the machine has sufficient memory and disk space.</p>

<p>When operating an on-premises FeatureBase cluster, we recommend that you restore backups to a realistically-configured cluster periodically.
This ensures that the processes and tools for restoring in the event of a disaster are available when needed.</p>

<h3 id="best-practices-for-production-backups-and-restores">Best Practices for Production Backups and Restores</h3>

<ul>
  <li>Back up frequently - recovering from an old backup means more data loss than a recent backup</li>
  <li>Store backups on multiple systems (in case one fails)</li>
  <li>Store at least one copy of the data off-site (in another datacenter or cloud)</li>
  <li>Keep at least one tested backup at any given time</li>
  <li>Backups should have at least the same level of security as the system being backed up - use appropriate access control and encrypt them (place them on encrypted storage and/or encrypt the files)</li>
  <li>Prepare/maintain/test any necessary scripts/tools/plans for recovering from a backup such that they are available when needed</li>
</ul>

<h3 id="comparison-to-molecula-v3x-backup-system">Comparison to Molecula v3.x Backup System</h3>

<p>Molecula v3.xâ€™s backup system worked by completely freezing writes, rsyncing the data, and resuming writes.
The backup data could only be safely restored into an identical cluster.
This option is not supported in Molecula v4.x.</p>

<p>The new process runs concurrently with writes, and is fully integrated into FeatureBase.
It works by acquiring a read lock on each individual file while copying.
Like the v3.x process it directly copies each database file in its original format for efficiency reasons.
It is accessed as a single shell command so that a complicated multi-step process is no longer needed.
The resulting backup data is independent of the cluster it was created from, and can be restored into a differently-configured cluster safely.</p>

                </section>
            </article>
    
            <!-- Right sidebar -->
            <nav class="container__right">
                <div>Applies to</div>

                <span>Please <a href="https://github.com/molecula/documentation/edit/gh-pages/reference/backups.md">help improve this article</a>.</span>

                <div>
                    <span>
                        Modified: 
                    </span>
                </div>

                <div>Feedback?</div>
            </nav>
        </main>
        <footer>
            <p> &copy; 2022 Molecula Corp.</p>
        </footer>
    </div>
  </body>
</html>
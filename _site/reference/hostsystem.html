<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Host System</title>
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div class="container">
        <header>
            <a href="/"> 
                <img src="/img/logo.svg" alt="Molecula Logo" class="logo">
            </a>
        </header>
        <main class="container__main">
            <!-- Left sidebar -->
            <aside class="container__left">
                <ul>
    
      
        <li><a href="/index.html">Home</a></li>
        
  
      
    
       
        <li><p>Tutorials</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/tutorials/getting-started.html">Getting Started</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Explanation</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/explanations/architecture.html">Architecture</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>How-Tos</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/how-tos/install-featurebase.html">Install FeatureBase</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Reference</a></li>
        
  
      
        <ul>
    
       
        <li><p>Interfaces</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/reference/apis.html">APIs</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Query Languages</a></li>
        
  
      
    
       
        <li><p>Operations</a></li>
        
  
      
    
       
        <li><p>Configuration</a></li>
        
  
      
    
      
        <li><a href="/reference/glossary.html">Glossary</a></li>
        
  
      
    
  </ul>

      
    
  </ul>

            </aside>
    
            <article class="container__middle">
                <h1>Host System</h1>
                <section>
                  <h2 id="operating-system-configuration">Operating System Configuration</h2>

<p>This page discusses software configuration issues commonly encountered when deploying Molecula. For hardware requirements or scaling, look at <a href="/how-tos/size-molecula-deployment">Sizing Molecula</a>.</p>

<p>Molecula’s data storage splits the database into a potentially large number of files, which are open simultaneously. Most Unix-derived systems limit the number of simultaneous open files for a given process or user, and these limits are frequently small enough to be a problem. Similarly, there may be limits on the number of memory-mapped regions allowed in a process. These may need to be changed,
either temporarily during initial development and testing, or as a machine-wide configuration change that persists across restarts.</p>

<p>Throughout these instructions, commands given with a root prompt (<code class="language-plaintext highlighter-rouge">#</code>) are expected to require root privileges; you can run them in a root shell, or using <code class="language-plaintext highlighter-rouge">sudo</code>.</p>

<h3 id="linux-systems">Linux Systems</h3>

<p>You can make temporary changes just to run the software once, or persistent changes which will survive reboots. We document both because the one-off changes are much easier to make, but in a production environment you will be happier making persistent changes.</p>

<p>To temporarily increase the open file limit, you should be able to use <code class="language-plaintext highlighter-rouge">ulimit -n</code>. If you can’t set the limit high enough, you will need root privileges. The <code class="language-plaintext highlighter-rouge">ulimit</code> program only affects the limits of the shell it’s run in and child processes of that shell, so you can’t use <code class="language-plaintext highlighter-rouge">sudo ulimit</code> to change the limit of your current shell; if you need to set a higher limit, launch a new shell using <code class="language-plaintext highlighter-rouge">sudo -s</code> or the equivalent, then change the ulimit, then use <code class="language-plaintext highlighter-rouge">su</code> to start a new shell running as your regular user but inheriting the higher limits. We do not recommend running Molecula with root privileges.</p>

<p>To temporarily increase the allowable memory-mapped regions on a Linux system, you can use the <code class="language-plaintext highlighter-rouge">sysctl</code> command, or just the <code class="language-plaintext highlighter-rouge">proc</code> filesystem:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># sysctl -w vm.max_map_count=N</span>
<span class="c"># echo N &gt; /proc/sys/vm/max_map_count</span>
</code></pre></div></div>

<h4 id="persistent-changes">Persistent Changes</h4>

<p>There are two likely paths to setting the system open files limit on Linux systems. One is to look at <code class="language-plaintext highlighter-rouge">/etc/security/limits.conf</code>, or <code class="language-plaintext highlighter-rouge">/etc/security/limits.d/*.conf</code>, which allow you to specify the <code class="language-plaintext highlighter-rouge">hard</code> limit for the item <code class="language-plaintext highlighter-rouge">nofile</code> for any user or group. The other is to use <code class="language-plaintext highlighter-rouge">sysctl</code>, and change the <code class="language-plaintext highlighter-rouge">fs.file-max</code> variable. This can be changed through <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code> or <code class="language-plaintext highlighter-rouge">/etc/sysctl.d/*.conf</code>. You can also use the <code class="language-plaintext highlighter-rouge">sysctl.conf</code> approach to change <code class="language-plaintext highlighter-rouge">vm.max_map_count</code> persistently.</p>

<p>Either way, you will need to restart your login session for the change to take effect, but it should be persistent after that. We recommend an open file limit of around 256K by default.</p>

<h4 id="enable-noatime">Enable noatime</h4>

<p>Due to frequent access, using <code class="language-plaintext highlighter-rouge">atime</code> updates can significantly reduce the performance
of FeatureBase. <code class="language-plaintext highlighter-rouge">noatime</code> should be used on the mount point for the FeatureBase data directory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  #!/bin/bash

  DATA_DIR="/opt/molecula/featurebase"

  PARTITION=$(df $DATA_DIR | awk 'NR==2 { print $1; exit }')

  MOUNT_POINT=$(df $DATA_DIR | awk 'NR==2 { print $6; exit }')

  MOUNT_OPTIONS=$(findmnt --source $PARTITION --output=options | sed -n '2p')

  if [[ "$MOUNT_OPTIONS" == *noatime* ]]; then
      echo "noatime is already enabled!"
  elif [[ $(lsblk $PARTITION -n --output=FSTYPE) == "xfs" &amp;&amp; "$MOUNT_OPTIONS" == *relatime* ]]; then
      echo "reltime is enabled, mount with noatime to improve performance; to mount with noatime:"
      echo "    mount -o remount,noatime $PARTITION $MOUNT_POINT"
  else
      echo "noatime should be enabled on the mount point for the data directory; to mount with noatime:"
      echo "    mount -o remount,noatime $PARTITION $MOUNT_POINT"
  fi

</code></pre></div></div>

<h4 id="enable-trim-on-ssds">Enable TRIM on SSDs</h4>

<p>On SSDs, TRIM should be enabled to reclaim the memory blocks that are no longer considered to be ‘in use’.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  #!/bin/bash

  DATA_DIR="/opt/molecula/featurebase"

  PARTITION=$(df $DATA_DIR | awk '{print $1}' | sed -n '2p')

  MOUNT_OPTIONS=$(findmnt --source $PARTITION --output=options | sed -n '2p')

  if [[ $(lsblk $PARTITION -n -o ROTA) == "1" ]]; then
      echo "The partition is on a rotational drive, TRIM not supported"
  elif [[ $(lsblk $PARTITION -n -o DISC-GRAN == "0B") ]]; then
      echo "DISC granularity 0, TRIM not supported"
  elif [[ $(systemctl is-enabled fstrim.timer) == "enabled" ]]; then
      echo "fstrim is already enabled!"
  else
      echo "fstrim must be enabled; to enable:"
      echo "    sudo systemctl enable fstrim.timer"
  fi

  if [[ "$MOUNT_OPTIONS" == *discard* ]]; then
      echo "Continuous TRIM(discard) is not recommended, switch to periodic TRIM(fstrim)"
  fi
</code></pre></div></div>

<h3 id="mac-os-systems">Mac OS Systems</h3>

<p>On Mac OS, <code class="language-plaintext highlighter-rouge">ulimit</code> does not behave predictably, and the way to change the limits changes between releases. Additionally, the system’s system integrity protection (SIP) functionality may prevent attempts to change this. For a more detailed writeup, have a look at Wilson Mar’s <a href="https://wilsonmar.github.io/maximum-limits/">maximum limits</a> page. The number of processes limit described there shouldn’t be significant for Molecula. Mac OS does not seem to have a direct parallel to the maximum map count limits found on Linux systems.</p>

<p>You can temporarily raise the open file limit using <code class="language-plaintext highlighter-rouge">launchctl limit maxfiles 262144 262144</code>, although this will not persist across reboots. To persist it across reboots, you need to cause this command to be run during system startup every time. The easiest way to do this is by adding things to <code class="language-plaintext highlighter-rouge">/Library/LaunchDaemons</code>, but you can’t do this while SIP is enabled, and you can’t run <code class="language-plaintext highlighter-rouge">csrutil</code> once the system is up and running.</p>

<p>To disable the system integrity protection feature, restart your laptop, and hold down command + R to enter Recovery Mode. Open a terminal and enter <code class="language-plaintext highlighter-rouge">csrutil disable</code>, then restart your computer as you normally would. Now that SIP is disabled, you can create new LaunchDaemons files that will affect system limits. Copy the contents of this example plist file (<a href="https://github.com/wilsonmar/mac-setup/blob/master/configs/limit.maxfiles.plist">source</a>) into a new file on your system located at <code class="language-plaintext highlighter-rouge">/Library/LaunchDaemons/limit.maxfiles.plist</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
<span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;dict&gt;</span>
    <span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;string&gt;</span>limit.maxfiles<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;array&gt;</span>
      <span class="nt">&lt;string&gt;</span>launchctl<span class="nt">&lt;/string&gt;</span>
      <span class="nt">&lt;string&gt;</span>limit<span class="nt">&lt;/string&gt;</span>
      <span class="nt">&lt;string&gt;</span>maxfiles<span class="nt">&lt;/string&gt;</span>
      <span class="nt">&lt;string&gt;</span>262144<span class="nt">&lt;/string&gt;</span>
      <span class="nt">&lt;string&gt;</span>262144<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;key&gt;</span>RunAtLoad<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;true/&gt;</span>
    <span class="nt">&lt;key&gt;</span>ServiceIPC<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;false/&gt;</span>
  <span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/plist&gt;</span>
</code></pre></div></div>

<p>Once this file is created, change its ownership to <code class="language-plaintext highlighter-rouge">root:wheel</code> and tell <code class="language-plaintext highlighter-rouge">launchd</code> to load it:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chown root:wheel /Library/LaunchDaemons/limit.maxfiles.plist</span>
<span class="c"># launchctl load -w /Library/LaunchDaemons/limit.maxfiles.plist</span>
</code></pre></div></div>

<p>As soon as the <code class="language-plaintext highlighter-rouge">launchctl limit</code> command runs (which also happens when you load the plist file), the limit is changed even in existing shells. To ensure the open file limit has successfully changed, run <code class="language-plaintext highlighter-rouge">ulimit -a</code>. Your open files should be set to a number greater than 256 (in the range of 262144). Once you’re confident that the changes haven’t destroyed anything, you probably want to turn SIP back on; go back to recovery mode, and run <code class="language-plaintext highlighter-rouge">csrutil enable</code>. You need the SIP functionality disabled to make these changes, but not to keep them once they’ve been made.</p>

<p>You may also need to adjust kernel parameters using <code class="language-plaintext highlighter-rouge">sysctl</code>, such as <code class="language-plaintext highlighter-rouge">kern.maxfiles</code> or <code class="language-plaintext highlighter-rouge">kern.maxfilesperproc</code>.</p>

<h4 id="enable-noatime-1">Enable noatime</h4>

<p>Due to frequent access, using <code class="language-plaintext highlighter-rouge">atime</code> updates can significantly reduce the performance
of FeatureBase. <code class="language-plaintext highlighter-rouge">noatime</code> should be used on the mount point for the FeatureBase data directory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  #!/bin/bash

  DATA_DIR="/opt/molecula/featurebase"

  PARTITION=$(df $DATA_DIR | awk 'NR==2 { print $1; exit }')

  MOUNT_POINT=$(df $DATA_DIR | awk 'NR==2 { print $9; exit }')

  MOUNT_OPTIONS=$(mount | grep -w $PARTITION)

  if [[ "$MOUNT_OPTIONS" == *noatime* ]]; then
      echo "noatime is already enabled"
  else
      echo "noatime should be enabled for the best performance; to mount with noatime:"
      echo "    mount -vuwo noatime $MOUNT_POINT"
  fi
</code></pre></div></div>

<h4 id="enable-trim-on-ssds-1">Enable TRIM on SSDs</h4>

<p>On SSDs, enable trim to reclaim the blocks of data are no longer considered to be ‘in use’.
On APFS, Trim is enabled by default and macOS automatically performs a TRIM operation on the
free disk space on boot. Use <code class="language-plaintext highlighter-rouge">#trimforce enable</code> to ensure that the TRIM is enabled.</p>

<h3 id="featurebase-trial-version">FeatureBase Trial Version</h3>
<p>If you are using a trial version of FeatureBase ensure that the host (and by extension FeatureBase)
can access the ntp server <code class="language-plaintext highlighter-rouge">0.beevik-ntp.pool.ntp.org</code> via the UDP port 123.</p>

                </section>
            </article>
    
            <!-- Right sidebar -->
            <nav class="container__right">
                <div>Applies to</div>

                <span>Please <a href="https://github.com/molecula/documentation/edit/gh-pages/reference/hostsystem.md">help improve this article</a>.</span>

                <div>
                    <span>
                        Modified: 
                    </span>
                </div>

                <div>Feedback?</div>
            </nav>
        </main>
        <footer>
            <p> &copy; 2022 Molecula Corp.</p>
        </footer>
    </div>
  </body>
</html>
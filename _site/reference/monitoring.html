<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Monitoring</title>
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div class="container">
        <header>
            <a href="/"> 
                <img src="/img/logo.svg" alt="Molecula Logo" class="logo">
            </a>
        </header>
        <main class="container__main">
            <!-- Left sidebar -->
            <aside class="container__left">
                <ul>
    
      
        <li><a href="/index.html">Home</a></li>
        
  
      
    
       
        <li><p>Tutorials</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/tutorials/getting-started.html">Getting Started</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Explanation</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/explanations/architecture.html">Architecture</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>How-Tos</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/how-tos/install-featurebase.html">Install FeatureBase</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Reference</a></li>
        
  
      
        <ul>
    
       
        <li><p>Interfaces</a></li>
        
  
      
        <ul>
    
      
        <li><a href="/reference/apis.html">APIs</a></li>
        
  
      
    
  </ul>

      
    
       
        <li><p>Query Languages</a></li>
        
  
      
    
       
        <li><p>Operations</a></li>
        
  
      
    
       
        <li><p>Configuration</a></li>
        
  
      
    
      
        <li><a href="/reference/glossary.html">Glossary</a></li>
        
  
      
    
  </ul>

      
    
  </ul>

            </aside>
    
            <article class="container__middle">
                <h1>Monitoring</h1>
                <section>
                  <h2 id="metrics">Metrics</h2>

<p>All Molecula components expose metrics via a <a href="https://prometheus.io">Prometheus</a>
compatible endpoint.</p>

<p>Exposed metrics are described for each component below.</p>

<h3 id="metric-naming-conventions">Metric naming conventions:</h3>

<ul>
  <li>Valid metric names match the regular expression <code class="language-plaintext highlighter-rouge">[a-zA-Z_:][a-zA-Z0-9_:]*</code>. The colon character is reserved for <a href="https://prometheus.io/docs/practices/rules/">recording rules</a> and is avoided otherwise.</li>
  <li>Format: <code class="language-plaintext highlighter-rouge">[namespaceprefix]_[metric_description]_[units]</code>. Example: <code class="language-plaintext highlighter-rouge">ingester_csv_deleter_rows_added_total</code> with namespace <code class="language-plaintext highlighter-rouge">ingester_csv</code>, metric name <code class="language-plaintext highlighter-rouge">deleter_rows_added</code>, and “unit” <code class="language-plaintext highlighter-rouge">total</code>, indicating a counter.</li>
  <li>Molecula uses a different namespace for each component, for example <code class="language-plaintext highlighter-rouge">featurebase</code> and something starting with <code class="language-plaintext highlighter-rouge">ingester</code> for various Ingester binaries.</li>
  <li><code class="language-plaintext highlighter-rouge">snake_case</code>, not <code class="language-plaintext highlighter-rouge">camelCase</code></li>
  <li>As a rule of thumb, either the sum() or the avg() over all dimensions of a given metric should be meaningful (though not necessarily useful).</li>
</ul>

<p>For more information, see <a href="https://prometheus.io/docs/practices/naming/">Prometheus best practices on naming</a>, and <a href="https://www.robustperception.io/on-the-naming-of-things">this related blog post</a>.</p>

<h3 id="label-descriptions">Label Descriptions</h3>

<p>Some metrics are labeled, with labels following a key-value format. Some of these labels are used with multiple metrics, including the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">index:&lt;indexname&gt;</code> - FeatureBase index</li>
  <li><code class="language-plaintext highlighter-rouge">field:&lt;fieldname&gt;</code> - FeatureBase field</li>
  <li><code class="language-plaintext highlighter-rouge">node_id:&lt;nodeID&gt;</code> - FeatureBase node ID</li>
</ul>

<p>Some metrics are specific to individual components, and described below.</p>

<h3 id="ingesters-metrics">Ingesters Metrics</h3>

<p>| Metric Name                                                           | Description                         |
| -                                                                     | -                                   |
| <code class="language-plaintext highlighter-rouge">[namespaceprefix]_deleter_rows_added_total</code>                          | count of rows ingested for deletion<br />(labels: type={packed-bool,set,mutex,bool,int,decimal}) |
| <code class="language-plaintext highlighter-rouge">[namespaceprefix]_ingester_schema_changes_total                      | count of schema changes |
| </code>[namespaceprefix]_ingester_rows_added_total<code class="language-plaintext highlighter-rouge">                         | count of rows ingested |
| </code>[namespaceprefix]_batch_import_duration_seconds`                     | per-batch import timing. Timings start from when the <br />last record was added to the batch and<br />end when the batch was fully imported.<br />Prior to Molecula 3.0, this only timed importing processed<br />batch data, and elided key translation and local processing.<br />Note that this is reported within go-pilosa. |</p>

<p>where in the case of Ingesters, <code class="language-plaintext highlighter-rouge">[namespaceprefix]</code> is one of:</p>
<ul>
  <li>ingester_csv</li>
  <li>ingester_kafka</li>
  <li>ingester_sql</li>
</ul>

<h3 id="featurebase-metrics">FeatureBase Metrics</h3>

<table>
  <thead>
    <tr>
      <th>Metric Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_create_index_total</code></td>
      <td>count of successful index creations</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_delete_index_total</code></td>
      <td>count of successful index deletions</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_create_field_total</code></td>
      <td>count of successful field creations</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_delete_field_total</code></td>
      <td>count of successful field deletions</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_delete_available_shard_total</code></td>
      <td>count of successful shard deletions</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_recalculate_cache_total</code></td>
      <td>count of cache recalculations</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_invalidate_cache_total</code></td>
      <td>count of cache invalidations</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_invalidate_cache_skipped_total</code></td>
      <td>count of skipped cache invalidations</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_dirty_cache_total</code></td>
      <td>count of dirty cache</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_rank_cache_length</code></td>
      <td>gauge of cache length</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_cache_threshold_reached_total</code></td>
      <td>count of times cache reaches threshold and trimming is required</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_query_row_total</code></td>
      <td>count of row queries</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_query_row_bsi_total</code></td>
      <td>count of row queries that operate on a BSI (integer) field</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_set_bit_total</code></td>
      <td>count of set bits, set by a query (as opposed to an import)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_clear_bit_total</code></td>
      <td>count of clear bits, set by a query (as opposed to an import)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_importing_total</code></td>
      <td>count of imported set bits, before importing</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_imported_total</code></td>
      <td>count of imported set bits, after successfully importing (number that actually changed)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_clearing_total</code></td>
      <td>count of imported clear bits, before importing</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_cleared_total</code></td>
      <td>count of imported clear bits, after successfully importing (number that actually changed)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_snapshot_duration_seconds</code></td>
      <td>timing histogram of the snapshot process</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_block_repair_total</code></td>
      <td>count (labels: primary={true,false})</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_sync_field_duration_seconds</code></td>
      <td>timing histogram of the field sync process</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_sync_index_duration_seconds</code></td>
      <td>timing histogram of the index sync process</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_http_request_duration_seconds</code></td>
      <td>timing histogram of all http requests. Labels: where, <br />  - <code class="language-plaintext highlighter-rouge">where</code> - a value of <code class="language-plaintext highlighter-rouge">internal</code> indicates an in-cluster request, <code class="language-plaintext highlighter-rouge">external</code> indicates a request from outside the cluster<br /> - <code class="language-plaintext highlighter-rouge">path</code> - the path used to make a request. For example, <code class="language-plaintext highlighter-rouge">/index/&lt;index&gt;/query</code> for an HTTP PQL query request.<br /> - <code class="language-plaintext highlighter-rouge">useragent</code> - the user agent string used to make a request. For example, <code class="language-plaintext highlighter-rouge">curl/7.54.0</code>.<br /> - <code class="language-plaintext highlighter-rouge">method</code> - the method used to make a request. For example, <code class="language-plaintext highlighter-rouge">POST</code>.<br /> - <code class="language-plaintext highlighter-rouge">slow</code> - <code class="language-plaintext highlighter-rouge">true</code> or <code class="language-plaintext highlighter-rouge">false</code> indicates a “slow query” based on the <code class="language-plaintext highlighter-rouge">long-query-time</code> configuration option for FeatureBase</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_grpc_request_pql_unary_query_duration_seconds</code></td>
      <td>timing histogram of the query processing part of unary GRPC requests</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_grpc_request_pql_unary_format_duration_seconds</code></td>
      <td>timing histogram of the result formatting part of unary GRPC requests</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_grpc_request_pql_stream_query_duration_seconds</code></td>
      <td>timing histogram of the query processing part of streaming GRPC requests</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_grpc_request_pql_stream_format_duration_seconds</code></td>
      <td>timing histogram of the result formatting part of streaming GRPC requests</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_maximum_shard</code></td>
      <td>gauge of the maximum shard in the index. For indexes which use <code class="language-plaintext highlighter-rouge">keys: true</code>,<br />expect to see this around a multiple of 256<br />due to how keys are partitioned around shards.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_antientropy_total</code></td>
      <td>count of times the AntiEntropy process runs</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_antientropy_duration_seconds</code></td>
      <td>histogram of duration of AntiEntropy process</td>
    </tr>
  </tbody>
</table>

<p>where <code class="language-plaintext highlighter-rouge">[featurebaseprefix]</code> is either <code class="language-plaintext highlighter-rouge">featurebase</code> if the <a href="/reference/featurebase-rename"><code class="language-plaintext highlighter-rouge">--future.rename</code> configuration flag</a> is set, or <code class="language-plaintext highlighter-rouge">pilosa</code>.</p>

<p>In addition, metrics are generated for counts of individual query calls. These are identified by the <code class="language-plaintext highlighter-rouge">query</code> prefix, for example <code class="language-plaintext highlighter-rouge">query_topn_total</code>. For PQL calls, these include the following queries: <code class="language-plaintext highlighter-rouge">Sum</code>, <code class="language-plaintext highlighter-rouge">Min</code>, <code class="language-plaintext highlighter-rouge">Max</code>, <code class="language-plaintext highlighter-rouge">MinRow</code>, <code class="language-plaintext highlighter-rouge">MaxRow</code>, <code class="language-plaintext highlighter-rouge">Count</code>, <code class="language-plaintext highlighter-rouge">TopN</code>, <code class="language-plaintext highlighter-rouge">Rows</code>, <code class="language-plaintext highlighter-rouge">GroupBy</code>. Note that the query name is represented as lower-case in the metric name. SQL calls may also affect these metrics, depending on SQL-&gt;PQL mapping of the particular query.</p>

<h3 id="runtime-metrics">Runtime Metrics</h3>

<p>These metrics are pulled from the Go language runtime or operating system rather than being generated by FeatureBase itself. Note that these metrics are enabled by setting FeatureBase’s configuration variable <code class="language-plaintext highlighter-rouge">metric.poll-interval</code> to a non-zero value.</p>

<table>
  <thead>
    <tr>
      <th>Metric Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_garbage_collection_total</code></td>
      <td>counter</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_goroutines</code></td>
      <td>gauge</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_open_files</code></td>
      <td>gauge. FeatureBase can use a large number of open files <br /> depending on the amount of data and the schema. <br /> A sudden jump in the number of open files <br /> could indicate an issue.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_heap_alloc</code></td>
      <td>gauge</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_heap_inuse</code></td>
      <td>gauge</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_stack_inuse</code></td>
      <td>gauge</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_mallocs</code></td>
      <td>gauge</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[featurebaseprefix]_frees</code></td>
      <td>gauge</td>
    </tr>
  </tbody>
</table>

<p>where <code class="language-plaintext highlighter-rouge">[featurebaseprefix]</code> is either <code class="language-plaintext highlighter-rouge">featurebase</code> if the <a href="/reference/featurebase-rename"><code class="language-plaintext highlighter-rouge">--future.rename</code> configuration flag</a> is set, or <code class="language-plaintext highlighter-rouge">pilosa</code>.</p>

<h3 id="transaction-metrics">Transaction Metrics</h3>
<p>| Metric Name                                         | Description                              |
| -                                                   | -                                        |
| <code class="language-plaintext highlighter-rouge">[featurebaseprefix]_transaction_start</code>             | count of started transactions            |
| <code class="language-plaintext highlighter-rouge">[featurebaseprefix]_transaction_end</code>               | count of ended transactions              |
| <code class="language-plaintext highlighter-rouge">[featurebaseprefix]_transaction_blocked</code>           | count of blocked transactions            |
| <code class="language-plaintext highlighter-rouge">[featurebaseprefix]_transaction_exclusive_request</code> | count of exclusive transaction requests  |
| <code class="language-plaintext highlighter-rouge">[featurebaseprefix]_transaction_exclusive_active</code>  |  count of active exclusive transactions  |
| <code class="language-plaintext highlighter-rouge">[featurebaseprefix]_transaction_exclusive_end</code>     |  count of ended exclusive transactions   |
| <code class="language-plaintext highlighter-rouge">[featurebaseprefix]_transaction_exclusive_blocked</code> |  count of blocked exclusive transactions |</p>

<p>where <code class="language-plaintext highlighter-rouge">[featurebaseprefix]</code> is either <code class="language-plaintext highlighter-rouge">featurebase</code> if the <a href="/reference/featurebase-rename"><code class="language-plaintext highlighter-rouge">--future.rename</code> configuration flag</a> is set, or <code class="language-plaintext highlighter-rouge">pilosa</code>.</p>

<h3 id="query-metrics-not-implemented">Query Metrics (not implemented)</h3>
<p>| Metric Name                             | Description          |
| -                                       | -                    |
| <code class="language-plaintext highlighter-rouge">[featurebaseprefix]_pql_queries_total</code> | count of PQL queries |
| <code class="language-plaintext highlighter-rouge">[featurebaseprefix]_sql_queries_total</code> | count of SQL queries |</p>

<p>where <code class="language-plaintext highlighter-rouge">[featurebaseprefix]</code> is either <code class="language-plaintext highlighter-rouge">featurebase</code> if the <a href="/reference/featurebase-rename"><code class="language-plaintext highlighter-rouge">--future.rename</code> configuration flag</a> is set, or <code class="language-plaintext highlighter-rouge">pilosa</code>.</p>

<h3 id="prometheus-configuration">Prometheus Configuration</h3>

<p>Reporting metrics to Prometheus is enabled by default for Ingesters (at :9093/metrics); <code class="language-plaintext highlighter-rouge">host:port</code> can be specified with the <code class="language-plaintext highlighter-rouge">--stats</code> flag.</p>

<p>For FeatureBase, reporting must be enabled, as detailed on the <a href="/reference/featurebase-configuration#metric-service">Configuration page</a>. E.g.</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[metric]</span>
  <span class="py">service</span> <span class="p">=</span> <span class="s">"prometheus"</span>
  <span class="py">poll-interval</span> <span class="p">=</span> <span class="s">"0m15s"</span>
</code></pre></div></div>

<p>Below is an example configuration excerpt for Prometheus (the <code class="language-plaintext highlighter-rouge">scrape_configs</code> section), using the default reporting settings for FeatureBase and Ingesters:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">featurebase'</span>
    <span class="na">static_configs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">localhost:10101'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">localhost:10102'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">localhost:10103'</span><span class="pi">]</span>

  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ingester'</span>
    <span class="na">static_configs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">localhost:9093'</span><span class="pi">]</span>
</code></pre></div></div>

<h2 id="logging">Logging</h2>

<p>All Molecula components log to standard error by default and can be configured to log to a file. When logging to a file, Molecula components will re-open the log file on receipt of the HUP signal. See <a href="/how-tos/set-up-log-rotation">How To Set Up Log Rotation</a> for more information.</p>

<h2 id="tracing">Tracing</h2>

<p>Molecula supports tracing via the <a href="https://opentracing.io/">OpenTracing</a> standard. With this, tools such as <a href="https://www.jaegertracing.io/">Jaeger</a> can be used to store and visualize trace data.</p>

<h2 id="external-diagnostics">External Diagnostics</h2>

<p>Depending on contract details, Molecula may require the ability to “phone home” limited diagnostic information about its usage for billing, debugging, and license enforcement purposes. The details of connectivity and particulars of the data involved will be agreed upon prior to deployment.</p>

<h2 id="health-checks">Health Checks</h2>

<h4 id="featurebase">FeatureBase</h4>

<p>FeatureBase’s <code class="language-plaintext highlighter-rouge">/status</code> endpoint will respond with a JSON document describing the overall state of the cluster (NORMAL, DEGRADED, STARTING, DOWN, or RESIZING), along with some information about each node.</p>

<h4 id="other-components">Other Components</h4>

<p>To check the health of other Molecula components, use their Prometheus metrics endpoint.</p>

<h2 id="scaling">Scaling</h2>

<h3 id="featurebase-1">FeatureBase</h3>

<p>To scale FeatureBase up, add a node to the cluster and provision it similarly to the others (with its own bind), and make sure it has gossip seeds which are already in the cluster. It will automatically join the cluster and FeatureBase will initiate a resize operation to balance the data in the cluster.</p>

<p>To scale FeatureBase down, decide which node you want to remove. Get the node’s ID by querying FeatureBase’s <code class="language-plaintext highlighter-rouge">/status</code> endpoint. Shut the node down. Issue a POST request to the cluster coordinator node with a JSON document specifying the node’s ID as the payload. E.g.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-XPOST</span> https://coordinator:10101/cluster/resize/remove-node <span class="nt">-d</span><span class="s1">'{"id": "d39851e7-9444-4033-a534-c92c1b470a8e"}'</span>
</code></pre></div></div>

<p>FeatureBase will put the cluster into the RESIZING state and move data as necessary to make sure all nodes contain the correct shards given the cluster’s replication factor.</p>

<p>While FeatureBase is in the RESIZING state, it denies any request which accesses index data (<code class="language-plaintext highlighter-rouge">/status</code>, <code class="language-plaintext highlighter-rouge">/version</code>, etc. still work).</p>

<h3 id="ingester">Ingester</h3>

<p>Generally, scaling is handled by starting or stopping Ingester instances. Other options may be available for specific Ingesters; see <a href="/explanations/ingesters#ingest-tuning">ingest tuning</a></p>

                </section>
            </article>
    
            <!-- Right sidebar -->
            <nav class="container__right">
                <div>Applies to</div>

                <span>Please <a href="https://github.com/molecula/documentation/edit/gh-pages/reference/monitoring.md">help improve this article</a>.</span>

                <div>
                    <span>
                        Modified: 
                    </span>
                </div>

                <div>Feedback?</div>
            </nav>
        </main>
        <footer>
            <p> &copy; 2022 Molecula Corp.</p>
        </footer>
    </div>
  </body>
</html>